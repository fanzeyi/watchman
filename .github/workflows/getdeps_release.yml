# This file was @generated by getdeps.py

name: release

on:
  push:
    tags:
      - v*

jobs:
  prepare:
    runs-on: ubuntu-18.04
    outputs:
      release_name: ${{ steps.info.outputs.name }}
    steps:
    - name: Prepare release info
      id: info
      env:
        TAG: ${{ github.ref }}
      run: python -c "print('::set-output name=name::' + '$TAG'.lstrip('refs/tags/'))"
  linux-build:
    continue-on-error: true
    needs: prepare
    runs-on: ubuntu-18.04
    steps:
    - uses: actions/checkout@v1
    - name: Install system deps
      run: sudo python3 build/fbcode_builder/getdeps.py --allow-system-packages install-system-deps --recursive watchman
    - name: Fetch boost
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests boost
    - name: Fetch ninja
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests ninja
    - name: Fetch cmake
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests cmake
    - name: Fetch cpptoml
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests cpptoml
    - name: Fetch googletest
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests googletest
    - name: Fetch pcre
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests pcre
    - name: Fetch fmt
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests fmt
    - name: Fetch python-six
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests python-six
    - name: Fetch zstd
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests zstd
    - name: Fetch double-conversion
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests double-conversion
    - name: Fetch gflags
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests gflags
    - name: Fetch glog
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests glog
    - name: Fetch libevent
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests libevent
    - name: Fetch lz4
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests lz4
    - name: Fetch snappy
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests snappy
    - name: Fetch folly
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests folly
    - name: Fetch rsocket-cpp
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests rsocket-cpp
    - name: Fetch autoconf
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests autoconf
    - name: Fetch automake
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests automake
    - name: Fetch libtool
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests libtool
    - name: Fetch bison
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests bison
    - name: Fetch libsodium
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests libsodium
    - name: Fetch fizz
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests fizz
    - name: Fetch flex
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests flex
    - name: Fetch wangle
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests wangle
    - name: Fetch fbthrift
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests fbthrift
    - name: Fetch fb303
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests fb303
    - name: Build boost
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests boost
    - name: Build ninja
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests ninja
    - name: Build cmake
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests cmake
    - name: Build cpptoml
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests cpptoml
    - name: Build googletest
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests googletest
    - name: Build pcre
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests pcre
    - name: Build fmt
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests fmt
    - name: Build python-six
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests python-six
    - name: Build zstd
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests zstd
    - name: Build double-conversion
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests double-conversion
    - name: Build gflags
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests gflags
    - name: Build glog
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests glog
    - name: Build libevent
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests libevent
    - name: Build lz4
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests lz4
    - name: Build snappy
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests snappy
    - name: Build folly
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests folly
    - name: Build rsocket-cpp
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests rsocket-cpp
    - name: Build autoconf
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests autoconf
    - name: Build automake
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests automake
    - name: Build libtool
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests libtool
    - name: Build bison
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests bison
    - name: Build libsodium
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests libsodium
    - name: Build fizz
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests fizz
    - name: Build flex
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests flex
    - name: Build wangle
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests wangle
    - name: Build fbthrift
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests fbthrift
    - name: Build fb303
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests fb303
    - name: Build watchman
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --src-dir=. watchman  --project-install-prefix watchman:/usr/local
    - name: Copy artifacts
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fixup-dyn-deps --strip --src-dir=. watchman _artifacts/linux  --project-install-prefix watchman:/usr/local --final-install-prefix /usr/local
    - uses: actions/upload-artifact@master
      with:
        name: watchman-linux-${{ needs.prepare.outputs.release_name }}
        path: _artifacts
    - name: Test watchman
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages test --src-dir=. watchman  --project-install-prefix watchman:/usr/local
  mac-build:
    continue-on-error: true
    needs: prepare
    runs-on: macOS-latest
    steps:
    - uses: actions/checkout@v1
    - name: Install system deps
      run: sudo python3 build/fbcode_builder/getdeps.py --allow-system-packages install-system-deps --recursive watchman
    - name: Fetch boost
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests boost
    - name: Fetch openssl
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests openssl
    - name: Fetch ninja
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests ninja
    - name: Fetch cmake
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests cmake
    - name: Fetch cpptoml
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests cpptoml
    - name: Fetch googletest
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests googletest
    - name: Fetch pcre
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests pcre
    - name: Fetch fmt
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests fmt
    - name: Fetch python-six
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests python-six
    - name: Fetch zstd
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests zstd
    - name: Fetch double-conversion
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests double-conversion
    - name: Fetch gflags
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests gflags
    - name: Fetch glog
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests glog
    - name: Fetch libevent
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests libevent
    - name: Fetch lz4
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests lz4
    - name: Fetch snappy
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests snappy
    - name: Fetch folly
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests folly
    - name: Fetch rsocket-cpp
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests rsocket-cpp
    - name: Fetch autoconf
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests autoconf
    - name: Fetch automake
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests automake
    - name: Fetch libtool
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests libtool
    - name: Fetch bison
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests bison
    - name: Fetch libsodium
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests libsodium
    - name: Fetch fizz
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests fizz
    - name: Fetch flex
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests flex
    - name: Fetch wangle
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests wangle
    - name: Fetch fbthrift
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests fbthrift
    - name: Fetch fb303
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests fb303
    - name: Build boost
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests boost
    - name: Build openssl
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests openssl
    - name: Build ninja
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests ninja
    - name: Build cmake
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests cmake
    - name: Build cpptoml
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests cpptoml
    - name: Build googletest
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests googletest
    - name: Build pcre
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests pcre
    - name: Build fmt
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests fmt
    - name: Build python-six
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests python-six
    - name: Build zstd
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests zstd
    - name: Build double-conversion
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests double-conversion
    - name: Build gflags
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests gflags
    - name: Build glog
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests glog
    - name: Build libevent
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests libevent
    - name: Build lz4
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests lz4
    - name: Build snappy
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests snappy
    - name: Build folly
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests folly
    - name: Build rsocket-cpp
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests rsocket-cpp
    - name: Build autoconf
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests autoconf
    - name: Build automake
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests automake
    - name: Build libtool
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests libtool
    - name: Build bison
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests bison
    - name: Build libsodium
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests libsodium
    - name: Build fizz
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests fizz
    - name: Build flex
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests flex
    - name: Build wangle
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests wangle
    - name: Build fbthrift
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests fbthrift
    - name: Build fb303
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests fb303
    - name: Build watchman
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --src-dir=. watchman  --project-install-prefix watchman:/usr/local
    - name: Copy artifacts
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fixup-dyn-deps --src-dir=. watchman _artifacts/mac  --project-install-prefix watchman:/usr/local --final-install-prefix /usr/local
    - uses: actions/upload-artifact@master
      with:
        name: watchman-mac-${{ needs.prepare.outputs.release_name }}
        path: _artifacts
    - name: Test watchman
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages test --src-dir=. watchman  --project-install-prefix watchman:/usr/local
  windows-build:
    continue-on-error: true
    needs: prepare
    runs-on: windows-2016
    steps:
    - uses: actions/checkout@v1
    - name: Export boost environment
      run: "echo ::set-env name=BOOST_ROOT::%BOOST_ROOT_1_69_0%"
      shell: cmd
    - name: Fix Git config
      run: git config --system core.longpaths true
    - name: Fetch boost
      run: python build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests boost
    - name: Fetch bison
      run: python build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests bison
    - name: Fetch flex
      run: python build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests flex
    - name: Fetch libsodium
      run: python build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests libsodium
    - name: Fetch ninja
      run: python build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests ninja
    - name: Fetch cmake
      run: python build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests cmake
    - name: Fetch cpptoml
      run: python build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests cpptoml
    - name: Fetch googletest
      run: python build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests googletest
    - name: Fetch pcre
      run: python build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests pcre
    - name: Fetch fmt
      run: python build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests fmt
    - name: Fetch python-six
      run: python build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests python-six
    - name: Fetch zstd
      run: python build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests zstd
    - name: Fetch double-conversion
      run: python build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests double-conversion
    - name: Fetch gflags
      run: python build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests gflags
    - name: Fetch glog
      run: python build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests glog
    - name: Fetch lz4
      run: python build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests lz4
    - name: Fetch snappy
      run: python build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests snappy
    - name: Fetch zlib
      run: python build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests zlib
    - name: Fetch perl
      run: python build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests perl
    - name: Fetch openssl
      run: python build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests openssl
    - name: Fetch libevent
      run: python build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests libevent
    - name: Fetch folly
      run: python build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests folly
    - name: Fetch fizz
      run: python build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests fizz
    - name: Fetch rsocket-cpp
      run: python build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests rsocket-cpp
    - name: Fetch wangle
      run: python build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests wangle
    - name: Fetch fbthrift
      run: python build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests fbthrift
    - name: Fetch fb303
      run: python build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests fb303
    - name: Build boost
      run: python build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests boost
    - name: Build bison
      run: python build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests bison
    - name: Build flex
      run: python build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests flex
    - name: Build libsodium
      run: python build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests libsodium
    - name: Build ninja
      run: python build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests ninja
    - name: Build cmake
      run: python build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests cmake
    - name: Build cpptoml
      run: python build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests cpptoml
    - name: Build googletest
      run: python build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests googletest
    - name: Build pcre
      run: python build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests pcre
    - name: Build fmt
      run: python build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests fmt
    - name: Build python-six
      run: python build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests python-six
    - name: Build zstd
      run: python build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests zstd
    - name: Build double-conversion
      run: python build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests double-conversion
    - name: Build gflags
      run: python build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests gflags
    - name: Build glog
      run: python build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests glog
    - name: Build lz4
      run: python build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests lz4
    - name: Build snappy
      run: python build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests snappy
    - name: Build zlib
      run: python build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests zlib
    - name: Build perl
      run: python build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests perl
    - name: Build openssl
      run: python build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests openssl
    - name: Build libevent
      run: python build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests libevent
    - name: Build folly
      run: python build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests folly
    - name: Build fizz
      run: python build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests fizz
    - name: Build rsocket-cpp
      run: python build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests rsocket-cpp
    - name: Build wangle
      run: python build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests wangle
    - name: Build fbthrift
      run: python build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests fbthrift
    - name: Build fb303
      run: python build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests fb303
    - name: Build watchman
      run: python build/fbcode_builder/getdeps.py --allow-system-packages build --src-dir=. watchman 
    - name: Copy artifacts
      run: python build/fbcode_builder/getdeps.py --allow-system-packages fixup-dyn-deps --src-dir=. watchman _artifacts/windows  --final-install-prefix /usr/local
    - uses: actions/upload-artifact@master
      with:
        name: watchman-windows-${{ needs.prepare.outputs.release_name }}
        path: _artifacts
    - name: Test watchman
      run: python build/fbcode_builder/getdeps.py --allow-system-packages test --src-dir=. watchman 

  release:
    needs: [prepare, linux-build, mac-build, windows-build]

    runs-on: ubuntu-18.04
    steps:
    - uses: actions/checkout@v1

    - name: Download artifact for Linux
      continue-on-error: true
      id: linux-download
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      uses: actions/download-artifact@v2
      with:
        name: watchman-linux-${{ needs.prepare.outputs.release_name }}

    - name: Download artifact for macOS
      continue-on-error: true
      id: mac-download
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      uses: actions/download-artifact@v2
      with:
        name: watchman-mac-${{ needs.prepare.outputs.release_name }}

    - name: Download artifact for Windows
      continue-on-error: true
      id: windows-download
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      uses: actions/download-artifact@v2
      with:
        name: watchman-windows-${{ needs.prepare.outputs.release_name }}

    - name: Create release
      id: create_release
      if: ${{ steps.linux-download.outcome == 'success' || steps.mac-download.outcome == 'success' || steps.windows-download.outcome == 'success' }}
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: ${{ github.ref }}

    - name: Create archive for Linux
      if: ${{  steps.linux-download.outcome == 'success' }}
      run: mv linux watchman-linux && zip -r watchman-${{ needs.prepare.outputs.release_name }}-linux.zip watchman-linux/
    - name: Upload Linux release
      if: ${{  steps.linux-download.outcome == 'success' }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      uses: actions/upload-release-asset@v1
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./watchman-${{ needs.prepare.outputs.release_name }}-linux.zip
        asset_name: watchman-${{ needs.prepare.outputs.release_name }}-linux.zip
        asset_content_type: application/zip

    - name: Create archive for macOS
      if: ${{  steps.mac-download.outcome == 'success' }}
      run: mv mac watchman-mac && zip -r watchman-${{ needs.prepare.outputs.release_name }}-darwin.zip watchman-mac/
    - name: Upload macOS release
      if: ${{  steps.mac-download.outcome == 'success' }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      uses: actions/upload-release-asset@v1
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./watchman-${{ needs.prepare.outputs.release_name }}-darwin.zip
        asset_name: watchman-${{ needs.prepare.outputs.release_name }}-darwin.zip
        asset_content_type: application/zip

    - name: Create archive for Windows
      if: ${{  steps.windows-download.outcome == 'success' }}
      run: mv windows watchman-windows && zip -r watchman-${{ needs.prepare.outputs.release_name }}-windows.zip watchman-windows/
    - name: Upload Windows release
      if: ${{  steps.windows-download.outcome == 'success' }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      uses: actions/upload-release-asset@v1
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./watchman-${{ needs.prepare.outputs.release_name }}-windows.zip
        asset_name: watchman-${{ needs.prepare.outputs.release_name }}-windows.zip
        asset_content_type: application/zip
